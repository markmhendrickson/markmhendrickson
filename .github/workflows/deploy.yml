name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      # Use REPO_ACCESS_TOKEN if shared (react-components) is private; otherwise GITHUB_TOKEN is enough
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.REPO_ACCESS_TOKEN || github.token }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: react-app/package-lock.json

      - name: Install dependencies
        working-directory: react-app
        run: npm ci

      - name: Write Neotoma export JSON (from secret)
        working-directory: react-app
        env:
          NEOTOMA_WEBSITE_EXPORT_JSON: ${{ secrets.NEOTOMA_WEBSITE_EXPORT_JSON }}
        run: |
          if [ -z "${NEOTOMA_WEBSITE_EXPORT_JSON:-}" ]; then
            echo "Missing NEOTOMA_WEBSITE_EXPORT_JSON secret." >&2
            exit 1
          fi
          mkdir -p data/tmp
          printf '%s' "$NEOTOMA_WEBSITE_EXPORT_JSON" | base64 --decode > data/tmp/neotoma_website_export.json

      - name: Generate cache from Neotoma export
        working-directory: react-app
        run: |
          python3 scripts/generate_cache.py --from-neotoma-json data/tmp/neotoma_website_export.json

      - name: Build
        working-directory: react-app
        env:
          VITE_GA_MEASUREMENT_ID: ${{ secrets.VITE_GA_MEASUREMENT_ID }}
        run: npm run build:ci

      # 404.html is generated by prerender (NotFound page) for unknown paths
      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: react-app/dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
